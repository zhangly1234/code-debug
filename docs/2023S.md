## å®‰è£…
1. è¿è¡Œä¸€érCore-Tutorial-Code-2023S ch9
2. æ ¹æ®è¿™ä¸ª[diffæ–‡ä»¶](https://github.com/chenzhiy2001/code-debug/blob/master/docs/diff-rCore-Tutorial-Code-2023S-kernel.diff)ä¿®æ”¹ä»£ç ï¼Œç„¶åè¿›å…¥userç›®å½•ï¼Œæ ¹æ®è¿™ä¸ª[diffæ–‡ä»¶](https://github.com/chenzhiy2001/code-debug/blob/master/docs/diff-rCore-Tutorial-Code-2023S-user.diff)ä¿®æ”¹ä»£ç ï¼Œç„¶åå†è·‘ä¸€éï¼Œç¡®ä¿èƒ½æ­£å¸¸è¿è¡Œ
3. ä¸‹è½½SiFiveæä¾›çš„[risc-vå·¥å…·é“¾](https://static.dev.sifive.com/dev-tools/riscv64-unknown-elf-gcc-8.3.0-2020.04.1-x86_64-linux-ubuntu14.tar.gz)ã€‚ä¸‹è½½åå°†è¯¥æ–‡ä»¶å¤åˆ¶åˆ°homeç›®å½•ä¸‹å¹¶è§£å‹. å°†å…¶ä¸­çš„bin/æ–‡ä»¶å¤¹åŠ å…¥ç¯å¢ƒå˜é‡.
4. `cd ..../your_dir/ && git clone https://github.com/chenzhiy2001/code-debug.git && cd code-debug/ && npm install` (ç¡®ä¿æ‚¨å·²ç»å®‰è£…äº†è¾ƒæ–°ç‰ˆæœ¬çš„npm)
5. æ‰“å¼€vscodeï¼Œæ‰“å¼€your_dir/code-debug/æ–‡ä»¶å¤¹.
6. åˆ‡æ¢åˆ°`br-chenzhiy2001-hardcode-for-2023S`åˆ†æ”¯ï¼Œç„¶åå°†code-debug/src/frontend/extension.tsä¸­çš„16è¡Œæ”¹æˆæ‚¨è¦debugçš„rCoreçš„ä½ç½®ï¼Œæ¯”å¦‚os.homedir() + "/rCore-Tutorial-Code-2023S"ï¼Œå†`npm install`.
    1. å¦‚æœæ‚¨ä¸æƒ³è¿™ä¹ˆåšï¼Œè€Œæ˜¯æƒ³ç•™åœ¨`master`åˆ†æ”¯ï¼Œé‚£ä¹ˆè¯·å‚ç…§[è¿™é‡Œ](#ç¡¬ç¼–ç æ•°æ®ä¿®æ”¹).
7. ä¿å­˜ï¼Œç„¶åæŒ‰f5,ä¼šå¼¹å‡ºä¸€ä¸ªæ–°çš„vscodeçª—å£. åœ¨æ–°çª—å£ä¸­æ‰“å¼€rCore-Tutorial-Code-2023S/
8. åœ¨ .vscode æ–‡ä»¶å¤¹ä¸­æ·»åŠ  launch.jsonæ–‡ä»¶ï¼Œå¹¶è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼ˆæ³¨æ„æœ‰ä¸‰å¤„`${userHome}/your/path/to/rCore-Tutorial-Code-2023S`è¦ä¿®æ”¹æˆä½ çš„rCoreçš„ä½ç½®ï¼‰ï¼Œä¿å­˜åå†ç¼–è¯‘è¿è¡Œä¸€érCoreï¼Œç„¶åæŒ‰F5å°±å¯ä»¥å¯åŠ¨gdbå¹¶è°ƒè¯•ã€‚
   ```
   //launch.json
   {
       "version": "0.2.0",
       "configurations": [
           {
               "type": "gdb",
               "request": "launch",
               "name": "Attach to Qemu",
               "executable": "${userHome}/your/path/to/rCore-Tutorial-Code-2023S/os/target/riscv64gc-unknown-none-elf/release/os", //ä¿®æ”¹${userHome}/your/path/to/
               "target": ":1234",
               "remote": true,
               "cwd": "${workspaceRoot}",
               "valuesFormatting": "parseText",
               "gdbpath": "riscv64-unknown-elf-gdb", //å¦‚æœGDBå¹¶æ²¡æœ‰æ­£å¸¸å¯åŠ¨ï¼Œå¯ä»¥å°è¯•æ”¹æˆç»å¯¹è·¯å¾„(å¦‚â€œ/home/username/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14/binâ€)
               "showDevDebugOutput":true,
               "internalConsoleOptions": "openOnSessionStart",
               "printCalls": true,
               "stopAtConnect": true,
               "qemuPath": "qemu-system-riscv64",
               "qemuArgs": [
                   "-M",
                   "128m",
                   "-machine",
                   "virt",
                   "-bios",
                   "${userHome}/your/path/to/rCore-Tutorial-Code-2023S/bootloader/rustsbi-qemu.bin",//ä¿®æ”¹${userHome}/your/path/to/
                   "-display",
                   "none",
                   "-device",
                   "loader,file=${userHome}/your/path/to/rCore-Tutorial-Code-2023S/os/target/riscv64gc-unknown-none-elf/release/os.bin,addr=0x80200000",//ä¿®æ”¹${userHome}/your/path/to/
                   "-drive",
                   "file=${userHome}/your/path/to/rCore-Tutorial-Code-2023S/user/target/riscv64gc-unknown-none-elf/release/fs.img,if=none,format=raw,id=x0",//ä¿®æ”¹${userHome}/your/path/to/
                   "-device",
                   "virtio-blk-device,drive=x0",
                   "-device",
                   "virtio-gpu-device",
                   "-device",
                   "virtio-keyboard-device",
                   "-device",
                   "virtio-mouse-device",
                   "-serial",
                   "stdio",
                   "-s",
                   "-S"
               ]
           },
       ]
   }
   ```
## ä½¿ç”¨
1. ç­‰ä¸€ä¼šï¼Œå–æ¯æ°´ï¼Œç›´åˆ°DEBUG CONSOLEä¸å†åˆ·æ–°å†…å®¹
1. æŒ‰TERMINALå¯ä»¥åˆ‡æ¢åˆ°ç»ˆç«¯è¾“å‡º
1. æŒ‰ä¸‹æ¸…é™¤æ‰€æœ‰æ–­ç‚¹ï¼ˆ`removeAllCliBreakpoints`ï¼‰æŒ‰é’®ï¼Œåœ¨å³ä¸Šè§’ï¼ŒğŸ—‘åƒåœ¾æ¡¶å›¾æ ‡
1. æŒ‰ä¸‹è®¾ç½®å†…æ ¸å…¥å£ï¼ˆ`setKernelInBreakpoints`ï¼‰æŒ‰é’®
1. æŒ‰ä¸‹å‡ºå£æ–­ç‚¹ï¼ˆ`setKernelOutBreakpoints`ï¼‰æŒ‰é’®
1. è®¾ç½®ä½ æƒ³è¦çš„å†…æ ¸ä»£ç å’Œç”¨æˆ·ç¨‹åºä»£ç çš„æ–­ç‚¹ï¼ˆæ¨èåœ¨main.rsçš„`trap::init()`è®¾ç½®ä¸€ä¸ªï¼Œåœ¨ch9b_initproc.rsçš„`println!("aaaa")`è¯­å¥è®¾ç½®ä¸€ä¸ªï¼‰
1. æŒ‰continueæŒ‰é’®(`|â–·`)å¼€å§‹è¿è¡ŒrCore-Tutorial.æ¥ä¸‹æ¥ä¸åœæŒ‰`|â–·`å°±è¡Œäº†.
    1. å½“è¿è¡Œåˆ°ä½äºå†…æ ¸å‡ºå£çš„æ–­ç‚¹æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ç”¨æˆ·æ€çš„æ–­ç‚¹
    1. åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­å¦‚æœæƒ³è§‚å¯Ÿå†…æ ¸å†…çš„æ‰§è¡Œæµï¼Œå¯ä»¥ç‚¹å‡»`gotokernel`æŒ‰é’®ï¼Œç„¶åç‚¹å‡»ç»§ç»­æŒ‰é’®ï¼Œç¨‹åºä¼šåœåœ¨å†…æ ¸çš„å…¥å£æ–­ç‚¹ï¼Œè¿™æ—¶ï¼Œå¯ä»¥å…ˆæŠŠå†…æ ¸å‡ºå£æ–­ç‚¹è®¾ç½®å¥½ï¼ˆç‚¹å‡»`setKernelOutBreakpoints`æŒ‰é’®ï¼‰ï¼Œæ¥ä¸‹æ¥ï¼Œå¯ä»¥åœ¨å†…æ ¸æ€è®¾ç½®æ–­ç‚¹ï¼Œç‚¹å‡»ç»§ç»­ï¼Œè¿è¡Œåˆ°å†…æ ¸çš„å‡ºå£æ–­ç‚¹ä¹‹åï¼Œä¼šå›åˆ°ç”¨æˆ·æ€ã€‚

## ç¡¬ç¼–ç æ•°æ®ä¿®æ”¹
æ”¹æˆä¸€ä¸ªvscodeè®¾ç½®é€‰é¡¹å¯èƒ½æ›´æ–¹ä¾¿ï¼Œæ¬¢è¿pr:

1. code-debug/src/mibase.ts
    1. 1255è¡Œï¼Œ65æ”¹æˆ79
    2. 1264è¡Œå’Œ343è¡Œï¼Œ135æ”¹æˆ148
    3. 1281è¡Œï¼Œ30æ”¹æˆ43
2. code-debug/src/frontend/extension.ts
    1. 15è¡Œinitprocæ”¹æˆch9b_initproc
    2. 16è¡Œæ”¹æˆæ‚¨è¦debugçš„rCoreçš„ä½ç½®ï¼Œæ¯”å¦‚os.homedir() + "/rCore-Tutorial-Code-2023S"
